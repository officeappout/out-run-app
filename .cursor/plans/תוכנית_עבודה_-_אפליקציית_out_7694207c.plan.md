---
name: תוכנית עבודה - אפליקציית OUT
overview: תוכנית עבודה מפורטת לבניית אפליקציית OUT לפי ה-PRD, החל ממסך Onboarding והקמת תשתית המשתמש, דרך מסך Setup והאלגוריתם החכם, ועד שילוב עם המסכים הקיימים.
todos:
  - id: user-store
    content: יצירת useUserStore עם פעולות initializeProfile, updateProfile, hasCompletedOnboarding ושמירה ב-localStorage
    status: completed
  - id: onboarding-service
    content: יצירת onboarding.service.ts עם mapAnswersToProfile ו-createInitialProgression לתרגום תשובות פשוטות לפרופיל מורכב
    status: completed
  - id: onboarding-page
    content: יצירת /app/onboarding/page.tsx עם בדיקת השלמה ו-redirect
    status: completed
    dependencies:
      - user-store
  - id: onboarding-flow
    content: "יצירת OnboardingFlow component עם אקורדיון: שם, גיל, משקל, רמת כושר, מטרה, מגדר"
    status: pending
    dependencies:
      - onboarding-service
      - user-store
  - id: setup-page
    content: יצירת /app/setup/page.tsx עם בדיקת פרופיל ו-redirect ל-onboarding אם חסר
    status: pending
    dependencies:
      - user-store
  - id: workout-setup-screen
    content: יצירת WorkoutSetupScreen עם סליידר זמן (15-60), בחירת פעילות, Toggle שילוב כוח בפארק
    status: pending
    dependencies:
      - setup-page
  - id: smart-match-service
    content: יצירת smart-match.service.ts עם אלגוריתם סינון פארקים לפי devices, difficultyLevel ו-userLevel
    status: pending
    dependencies:
      - user-store
  - id: map-integration
    content: עדכון MapPage לקבלת query params מ-Setup ושימוש ב-smart-match.service במקום יצירה אוטומטית
    status: pending
    dependencies:
      - smart-match-service
      - workout-setup-screen
  - id: geofence-service
    content: יצירת geofence.service.ts לבדיקת קרבה לפארק (<30מ) בזמן אימון פעיל
    status: pending
  - id: exercise-screen
    content: יצירת /app/workout/exercise/page.tsx עם וידאו, טיימר/חזרות, כפתור סיום וקבלת XP
    status: pending
    dependencies:
      - geofence-service
---

# תוכנית עבודה - אפליקציית OUT

## סקירה כללית

האפליקציה בנויה על Next.js 14 (App Router) עם TypeScript ו-Zustand לניהול State. המבנה הוא Feature-Based, והקוד הקיים כולל:

- Types מפורטים: `UserFullProfile`, `MapPark`, `Route`, `RunningProfile`
- Stores קיימים: `useRunStore`, `useMapStore`
- מסכים קיימים: `/map`, `/run`

## שלב 1: הקמת תשתית המשתמש (User Infrastructure)

### 1.1 יצירת useUserStore

**קובץ:** `src/features/user/store/useUserStore.ts`

- חנות Zustand לניהול `UserFullProfile`
- פעולות: `initializeProfile()`, `updateProfile()`, `hasCompletedOnboarding()`
- שמירה ב-localStorage (או AsyncStorage בעתיד)
- אתחול עם פרופיל ברירת מחדל (כל ה-domains ברמה 1)

### 1.2 יצירת שירותי Onboarding

**קובץ:** `src/features/user/services/onboarding.service.ts`

- פונקציה `mapAnswersToProfile()` - מתרגמת תשובות פשוטות לפרופיל מורכב:
  - "בקושי זז" → `initialFitnessTier: 1`, כל ה-domains ברמה 1
  - "מתאמן קבוע" → `initialFitnessTier: 3`, כל ה-domains ברמה 5
- פונקציה `createInitialProgression()` - יוצרת `UserProgression` עם כל ה-domains

## שלב 2: מסך Onboarding

### 2.1 יצירת דף Onboarding

**קובץ:** `src/app/onboarding/page.tsx`

- בדיקה: אם המשתמש כבר השלים Onboarding → redirect ל-`/setup`
- רכיב ראשי: `OnboardingFlow` (Client Component)

### 2.2 רכיב OnboardingFlow

**קובץ:** `src/features/user/components/OnboardingFlow.tsx`

**UI (אקורדיון):**

- שלב 1: שם (input טקסט)
- שלב 2: גיל (input מספר)
- שלב 3: משקל (input מספר)
- שלב 4: רמת כושר כללית (3 אפשרויות):
  - "בקושי זז" → `initialFitnessTier: 1`
  - "מתאמן מדי פעם" → `initialFitnessTier: 2`
  - "מתאמן קבוע" → `initialFitnessTier: 3`
- שלב 5: מטרה ראשית (4 אפשרויות מ-`mainGoal`)
- שלב 6: מגדר (3 אפשרויות)

**לוגיקה:**

- כל שלב נפתח/נסגר (אקורדיון)
- שמירת תשובות ב-state מקומי
- בסיום: קריאה ל-`onboarding.service.ts` → יצירת פרופיל → שמירה ב-`useUserStore` → redirect ל-`/setup`

### 2.3 רכיבי UI גנריים (אם חסרים)

**קבצים:** `src/components/ui/Accordion.tsx`, `src/components/ui/Button.tsx`

- רכיבי UI בסיסיים לפי Design System (טורקיז #00E5FF, פינות עגולות)

## שלב 3: מסך Setup (התאמת אימון)

### 3.1 יצירת דף Setup

**קובץ:** `src/app/setup/page.tsx`

- בדיקה: אם אין פרופיל → redirect ל-`/onboarding`
- רכיב ראשי: `WorkoutSetupScreen`

### 3.2 רכיב WorkoutSetupScreen

**קובץ:** `src/features/workout/components/WorkoutSetupScreen.tsx`

**UI (לפי תמונה 12.02.43.jpg):**

- סליידר זמן: 15-60 דקות (עם ערך ברירת מחדל 30)
- בחירת סוג פעילות: Toggle/Radio בין "הליכה" ו-"ריצה"
- Toggle קריטי: "שילוב כוח בפארק" (On/Off)
- כפתור "מצא מסלול" → נווט ל-`/map` עם פרמטרים

**State:**

- `selectedDuration` (15-60)
- `activityType` ('walk' | 'run')
- `includeParkWorkout` (boolean)

### 3.3 שירות Smart Match Algorithm

**קובץ:** `src/features/map/services/smart-match.service.ts`

**לוגיקה:**

```typescript
function findMatchingRoutes(
  userProfile: UserFullProfile,
  duration: number,
  activityType: 'walk' | 'run',
  includeParkWorkout: boolean
): Route[]
```

**אלגוריתם:**

1. אם `includeParkWorkout === true`:

   - סינון פארקים: `park.devices.length > 0`
   - סינון נוסף: רק פארקים ש-`park.devices.some(d => d.difficultyLevel <= userLevel)`
   - חישוב מסלולים שעוברים דרך הפארקים המסוננים

2. אם `includeParkWorkout === false`:

   - מסלולים נקיים (ללא פארקים)

3. סינון לפי זמן: רק מסלולים ש-`route.duration <= duration + 5` (buffer)

**שימוש:**

- נקרא מ-`/map` page עם הפרמטרים מה-Setup
- מעדכן את `useRunStore.suggestedRoutes`

## שלב 4: שילוב עם מסך Map הקיים

### 4.1 עדכון MapPage

**קובץ:** `src/app/map/page.tsx`

- קבלת פרמטרים מ-URL (query params): `?duration=30&activity=run&parkWorkout=true`
- אם יש פרמטרים → קריאה ל-`smart-match.service.ts` במקום יצירה אוטומטית
- העברת `activityType` ל-`useRunStore.setActivityType()`

### 4.2 עדכון RouteService

**קובץ:** `src/features/map/services/route.service.ts`

- וידוא תמיכה ביצירת מסלולים עם/בלי פארקים
- חישוב זמן מדויק לפי `activityType` (הליכה איטית יותר)

## שלב 5: שיפורים לאימון פעיל (Active Workout)

### 5.1 Geofence Logic

**קובץ:** `src/features/workout/services/geofence.service.ts`

- פונקציה `checkProximityToPark()` - בודקת אם המשתמש במרחק < 30מ' מפארק
- נקראת מ-`/run` page כל 5 שניות (או בזמן אמת עם GPS)
- כשמתקרבים → מעבר למסך תרגיל

### 5.2 מסך תרגיל (Exercise Screen)

**קובץ:** `src/app/workout/exercise/page.tsx`

**UI (לפי תמונה 12.02.04.jpg):**

- חצי עליון: וידאו (`ParkDevice.videoUrl`)
- חצי תחתון: טיימר/חזרות, כפתור "סיימתי"
- בסיום: קבלת XP, עדכון `useUserStore`, חזרה למצב הליכה

## מבנה תיקיות סופי

```
src/
├── app/
│   ├── onboarding/
│   │   └── page.tsx
│   ├── setup/
│   │   └── page.tsx
│   ├── map/
│   │   └── page.tsx (קיים - עדכון)
│   ├── run/
│   │   └── page.tsx (קיים)
│   └── workout/
│       └── exercise/
│           └── page.tsx
├── features/
│   ├── user/
│   │   ├── components/
│   │   │   └── OnboardingFlow.tsx
│   │   ├── services/
│   │   │   └── onboarding.service.ts
│   │   └── store/
│   │       └── useUserStore.ts
│   ├── workout/
│   │   ├── components/
│   │   │   └── WorkoutSetupScreen.tsx
│   │   └── services/
│   │       └── geofence.service.ts
│   ├── map/
│   │   └── services/
│   │       └── smart-match.service.ts (חדש)
│   └── [features קיימים...]
└── components/
    └── ui/ (רכיבי UI גנריים)
```

## סדר ביצוע מומלץ

1. **שלב 1** - תשתית המשתמש (useUserStore + onboarding.service)
2. **שלב 2** - מסך Onboarding (UI + לוגיקה)
3. **שלב 3** - מסך Setup (UI + חיבור ל-Smart Match)
4. **שלב 4** - שילוב עם Map (עדכון RouteService + MapPage)
5. **שלב 5** - Geofence + מסך תרגיל (אופציונלי ל-MVP)

## הערות טכניות

- **Design System**: צבע ראשי #00E5FF, פינות עגולות (rounded-2xl), צלליות עדינות
- **טיפוגרפיה**: גופנים עגולים (Heebo/Assistant בעברית) - כבר מוגדר ב-layout
- **State Management**: Zustand - חנויות נפרדות לכל feature
- **Mock Data**: שימוש ב-`MOCK_PARKS` הקיים, ללא Backend אמיתי
- **Navigation**: Next.js App Router עם redirects לפי מצב המשתמש